# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ğŸ¯ Overview
The Lola Cloud **Core Identity Service** (LCI) is a NestJS application that implements an IAM system.  It exposes a REST API, stores data in PostgreSQL via TypeORM, and uses JWT tokens for authentication.  The code follows a Cleanâ€‘Architecture style with the following main layers:

* **Domain** â€“ pure entities, DTOs and enums (`src/domain`).
* **Application** â€“ useâ€‘case services that orchestrate business logic (`src/application/usecases`).
* **Infrastructure** â€“ database and HTTP modules (`src/infrastructure`).
* **Services** â€“ external integrations, e.g., `RunwayService` for Cloudflareâ€‘like operations.

## ğŸš€ Common Commands
All commands are executed with **Bun** (the repository uses Bun as its package manager).  Use the following aliases from the root directory.

| Command | Purpose |
|---------|---------|
| `bun run build` | Transpile TypeScript to `dist/` (NestJS build). |
| `bun run start` | Start the compiled production server. |
| `bun run start:dev` | Start the server in watch mode for development. |
| `bun run start:debug` | Start with Node inspector attached. |
| `bun run lint` | Run ESLint and automatically fix problems. |
| `bun run format` | Format source files with Prettier. |
| `bun run test` | Run all unit tests with Jest. |
| `bun run test:watch` | Watch mode for unit tests. |
| `bun run test:cov` | Generate a coverage report. |
| `bun run test:e2e` | Run all endâ€‘toâ€‘end tests. |
| `bun run test:e2e <file>` | Run a single E2E test file, e.g., `bun run test:e2e test/e2e/v1/auth/sign-in/post.spec.ts`. |
| `bun run typeorm migration:generate <name>` | Generate a new migration based on schema differences. |
| `bun run typeorm migration:run` | Apply pending migrations (also executed automatically on startup). |
| `bun run typeorm migration:revert` | Revert the last migration. |

> **Tip:** Use `bun run typeorm` as a shortcut for the TypeORM CLI.

## ğŸ—‚ï¸ File & Folder Layout
```
src/
â”œâ”€â”€ application/     # Useâ€‘case services (business logic)
â”œâ”€â”€ domain/          # DTOs, enums, value objects
â”œâ”€â”€ infrastructure/  # DatabaseModule, HttpModule, external integrations
â”‚   â”œâ”€â”€ database/
â”‚   â””â”€â”€ http/
â”œâ”€â”€ services/        # Helper services like RunwayService
â””â”€â”€ main.ts          # NestJS bootstrap
```

## ğŸ” Environment Variables
The application expects the following variables (see `.env.example`):

| Variable | Description |
|----------|-------------|
| `APPLICATION_PORT` | Port where the server listens. |
| `DATABASE_URL` | PostgreSQL connection string. |
| `ENCRYPTION_STRING` | Secret used for hashing/encoding. |
| `SALT_ROUNDS` | Bcrypt salt rounds. |
| `LOLA_MICROSERVICE_SECRET` | Shared secret for Runway integration. |

Make sure to run `cp .env.example .env` and adjust the values before starting the app.

## âš™ï¸ Database & Migrations
* The `dataSource` is configured in `src/infrastructure/database/typeORM/data-source.ts`.
* `migrationsRun: true` means pending migrations are automatically applied on startup.
* Use `bun run typeorm migration:generate <name>` to scaffold a new migration.
* The migrations folder is `src/infrastructure/database/typeORM/migrations/`.

## ğŸ“š Testing
* **Unit tests** live in `src/**/*.spec.ts` and are run with `bun run test`.
* **E2E tests** are under `test/e2e/` and are executed with `bun run test:e2e`.
* To run a single E2E test file, supply the path: `bun run test:e2e test/e2e/v1/auth/sign-in/post.spec.ts`.

## ğŸ¤ Runway Integration
The `RunwayService` (see `src/services/runway/runway.service.ts`) talks to an external service on `http://localhost:3001`.  It uses the `LOLA_MICROSERVICE_SECRET` environment variable for the `Authorization` header.  All Runway useâ€‘cases are wired in `HttpModule` and exposed via the `/v1/runway` routes.

## ğŸ“– Documentation
* The project README contains a highâ€‘level description and installation steps.
* For detailed API contract, refer to the OpenAPI spec generated by NestJS at runtime (usually available under `/api` when the server is running).

## ğŸ‘€ Quick Checks
* **Run the dev server**: `bun run start:dev`.
* **Lint & format**: `bun run lint && bun run format`.
* **Run a single unit test**: `bun run test <path>`.

Feel free to ask for more detailed explanations of any module or component.
